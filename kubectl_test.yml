---
- name: (1) check export
  shell: |
    bash -lc "export -p"
  register: check_export
  changed_when: false

- block:
    - name: (2) get node
      shell: |
        bash -lc "kubectl get node -o wide"
      register: get_node
      # environment: # bash -lc "export -p" にKUBECONFIGが無い場合は必要
      #   KUBECONFIG: /etc/kubernetes/admin.conf
      retries: 10
      delay: 5
      until:
        - "'NotReady' not in get_node.stdout"
      changed_when: false

    - name: (3) get pod
      shell: |
        bash -lc "kubectl get pod -A -owide"
      register: get_pod
      retries: 10
      delay: 5
      until:
        - get_pod.stdout != ""
        - "'No resurse found' not in get_pod.stdout"
      changed_when: false

    - name: (4) cp file from VM to pod
      shell: |
        bash -lc "kubectl cp /root/kubectl-test.txt nginx:/."
      register: cp_pod

    - name: (5) exec pod
      shell: |
        bash -lc "kubectl exec -it nginx -- bash -c \"{{ item }};\""
      with_items: 
        - "hostname"
        - "ls -l /"
        - "ls -l $HOME"
        - "md5sum /kubectl-test.txt | awk '{ print $1 }'" # awk効いてない
        - "cat /kubectl-test.txt"
      register: exec_pod
      changed_when: false
      ignore_errors: yes

    - name: (6) show label
      shell: |
        bash -lc "kubectl get pod --show-labels"
      register: show_label
      changed_when: false

    - name: (7) backup -o yaml
      shell: |
        bash -lc "kubectl get pod test -o yaml > /root/pod-test-backup.yaml"
      args:
        creates: "/root/pod-test-backup.yaml"
      register: backup_o_yaml

    - name: (8) set patch file
      copy:
        src: "{{ CPF_patch_file }}"
        dest: "/root/patch_file.yaml"

    - name: (9) patch to pod
      shell: |
        bash -lc "kubectl patch pod test --patch-file /root/patch_file.yaml"
      register: patch_to_pod

    - name: (10) check patch
      shell: |
        bash -lc "kubectl get pod test -o yaml > /root/pod-test-check-patch.yaml"
      args:
        creates: "/root/pod-test-check-patch.yaml"
      register: check_patch

  when:
    - "'KUBECONFIG' in check_export.stdout"
